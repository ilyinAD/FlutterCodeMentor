openapi: 3.0.0
info:
  title: API
  version: "1.0"

paths:
  /submission:
    post:
      description: |
        Отправка посылки по задаче
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmissionRequest"
      responses:
        "201":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SubmissionResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "422":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"
  /task:
    post:
      description: |
        Создать задачу для курса. Создать задачу может только учитель.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskCreationRequest"
      responses:
        "201":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"

  /user:
    post:
      description: |
        Регистрация нового пользователя(ученик/учитель).
        Email должен быть уникальным в системе.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRegistrationRequest"
      responses:
        "201":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  
  /courses:
    post:
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CourseCreationRequest"
      responses:
        "201":
          headers:
            Location:
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CourseResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  schemas:
    SubmissionRequest:
      type: object
      required:
        - task_id
        - user_id
        - submission_type
      properties:
        task_id:
          type: integer
          minimum: 1
        user_id:
          type: integer
          minimum: 1
        submission_type:
          type: string
          enum: [code, github_link]
        code:
          type: string
        github_url:
          type: string
          format: uri
          pattern: "^https://github.com/([a-zA-Z0-9_-]+)/([a-zA-Z0-9_-]+)/?$"
      allOf:
        - if:
            properties:
              submission_type:
                enum: ["code"]
            required: ["code"]
          then:
            required: ["code"]
            not:
              required: ["github_url"]
        - if:
            properties:
              submission_type:
                enum: ["github_link"]
            required: ["github_url"]
          then:
            required: ["github_url"]
            not:
              required: ["code"]

    SubmissionResponse:
      type: object
      properties:
        submission_id:
          type: integer
        created_at:
          type: string
          format: date-time
        status:
          type: string
          enum: [pending, ai_reviewed, teacher_reviewed]

    ValidationError:
      type: object
      properties:
        error:
          type: string
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
    
    TaskCreationRequest:
      type: object
      required:
        - course_id
        - title
        - description
        - deadline
        - max_score
      properties:
        course_id:
          type: integer
          minimum: 1
        title:
          type: string
          minLength: 5
          maxLength: 100
        description:
          type: string
          minLength: 10
        deadline:
          type: string
          format: date-time
        max_score:
          type: integer
          minimum: 1
          maximum: 100
        criteria:
          type: array
          items:
            $ref: "#/components/schemas/TaskCriteriaRequest"
      additionalProperties: false

    TaskCriteriaRequest:
      type: object
      required:
        - criterion_name
        - criterion_description
        - weight
      properties:
        criterion_name:
          type: string
          minLength: 3
          maxLength: 100
        criterion_description:
          type: string
          minLength: 10
        is_mandatory:
          type: boolean
          default: true
        weight:
          type: integer
          minimum: 1
          maximum: 100
          default: 10

    TaskResponse:
      type: object
      properties:
        task_id:
          type: integer
        course_id:
          type: integer
        title:
          type: string
        status:
          type: string
          enum: [active, archived]
        created_at:
          type: string
          format: date-time

    UserRegistrationRequest:
      type: object
      required:
        - email
        - password
        - role
        - first_name
        - last_name
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 12
        role:
          type: string
          enum: [student, teacher]
        first_name:
          type: string
          minLength: 2
          maxLength: 50
        last_name:
          type: string
          minLength: 2
          maxLength: 50
      additionalProperties: false

    UserResponse:
      type: object
      properties:
        user_id:
          type: integer
        email:
          type: string
        role:
          type: string
          enum: [student, teacher, admin]
        created_at:
          type: string
          format: date-time

    ApiError:
      type: object
      properties:
        error:
          type: string
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string

    CourseCreationRequest:
      type: object
      required:
        - title
        - start_date
        - teacher_id
      properties:
        teacher_id:
          type: integer
        title:
          type: string
          minLength: 3
          maxLength: 100
        description:
          type: string
        start_date:
          type: string
          format: date-time
        end_date:
          type: string
          format: date-time
        is_active:
          type: boolean
      additionalProperties: false
      allOf:
        - if:
            properties:
              end_date:
                type: string
            required: [end_date]
          then:
            properties:
              end_date:
                format: date-time
            required: [start_date]
            x-validation: end_date > start_date

    CourseResponse:
      type: object
      properties:
        course_id:
          type: integer
        teacher_id:
          type: integer
        title:
          type: string
        description:
          type: string
        start_date:
          type: string
          format: date-time
        end_date:
          type: string
          format: date-time
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time

  responses:
    BadRequest:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ValidationError"
    
    NotFound:
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
    
    Forbidden:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiError"
          example:
            error: "Only teachers can create tasks"

    Conflict:
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiError"